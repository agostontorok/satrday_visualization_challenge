---
title: "satRday challenge"
author: "Agoston Torok & Fanni Kling"
date: '2016 augusztus 18 '
output: html_document
---

```{r setup, include=FALSE}
#install.packages(pkgs="gdata")
options(java.parameters = "-Xmx4000m")
if (!"xlsx" %in% installed.packages()) install.packages("xlsx")
library("xlsx")

df <- read.xlsx2("BUD flights 2007-2012.xlsx", sheetIndex = 1,
                 colClasses = c(rep("character", 7),
                                "Date",
                                "numeric",
                                rep("character", 3),
                                rep("numeric", 4)))
```

## Map Creation

First let's read the longitude and lattitude coordinates of the the different countries [citation](https://www.r-bloggers.com/r-beginners-plotting-locations-on-to-a-world-map/). 

```{r readLocations}
library(stringi)
if (!"ggmap" %in% installed.packages()) install.packages("ggmap")
library(ggmap)

locationsCountryFileName <- "locations_country_lon_lat.csv"

if (file.exists(locationsCountryFileName)){
  locationCountryCoordinates <- read.csv(locationsCountryFileName, header = TRUE)
} else {
  destinationCountries <- unique(as.character(df$COUNTRY))
  locationCountryCoordinates <- geocode(destinationCountries)
  locationCountryCoordinates$COUNTRY <- destinationCountries
  write.csv(locationCountryCoordinates, locationsCountryFileName)
}

locationsCityFileName <- "locations_cities_lon_lat.csv"

if (file.exists(locationsCityFileName)){
  locationCityCoordinates <- read.csv(locationsCityFileName)
} else {
  destinationCities <- unique(as.character(df$DESTINATION))
  locationCityCoordinates <- geocode(destinationCities)
  locationCityCoordinates$DESTINATION <- destinationCities
  write.csv(locationCityCoordinates, locationsCityFileName)
}

library(plyr)
  
locationCountryCoordinates$X <- NULL
locationCityCoordinates$X <- NULL

locationCityCoordinates <- rename(locationCityCoordinates, c("lon"="lonCi", "lat"="latCi"))
df <- merge(df, locationCityCoordinates)
locationCountryCoordinates <- rename(locationCountryCoordinates, c("lon"="lonCo", "lat"="latCo"))
df <- merge(df, locationCountryCoordinates)
```

Then display a world map using the [Mollweide projection](https://en.wikipedia.org/wiki/Mollweide_projection). This projection is used because it emphasizes the accuracy of relative sizes of land and sea parts. The method used here is based on the example and polygon of [Bob Rudis](http://stackoverflow.com/a/27901570/5360901). For the animation we used the [gganimate](https://www.ggplot2-exts.org/gganimate.html) package by David Robinson. 

Because we were working on Windows, setting up ffmepeg and imagemagick required a little effort. With imagemagick 


```{r staticWorldMap}
if (!"sp" %in% installed.packages()) install.packages("sp")
library("sp")
if (!"maps" %in% installed.packages()) install.packages("maps")
library("maps")
if (!"rgdal" %in% installed.packages()) install.packages("rgdal")
library("rgdal")
if (!"rgeos" %in% installed.packages()) install.packages("rgeos")
library("rgeos")
if (!"gganimate" %in% installed.packages()) devtools::install_github("dgrtwo/gganimate")
library(gganimate)


world <- readOGR("ne_50m_admin_0_countries.geojson", "OGRGeoJSON")
outline <- bbox(world)
outline <- data.frame(xmin=outline["x","min"],
                      xmax=outline["x","max"],
                      ymin=outline["y","min"],
                      ymax=outline["y","max"])

world <- fortify(world)

points <- data.frame(lon=c(-98.35, 134.21), lat=c(39.5, -25.36))

gg <- ggplot()
# first let's create the sea
gg <- gg + geom_rect(data=outline, 
                     aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), 
                     color=1, fill="lightblue", size=0.3)
# then let the land emerge
gg <- gg + geom_map(data=world, map=world,
                    aes(x=long, y=lat, map_id=id), 
                    fill="darkseagreen", color="gray10", size=0.3)
# then let people populate the Earth
gg <- gg + geom_point(aes(x=lon, y=lat, size=CARGO.WEIGHT, frame=DATE),
                      data=df, col="orange", alpha=0.4)
gg <- gg + coord_map("mollweide")

# make the plot pretty
gg <- gg + theme_bw()
gg <- gg + labs(x=NULL, y=NULL)
gg <- gg + theme(panel.grid=element_blank(),
                 legend.position="none", panel.border=element_blank(),
                 axis.ticks=element_blank(),
                 axis.text=element_blank())
#gg_animate(gg, interval = 0.2, saver = "mp4", filename = "cargo_weights.mp4") #, filename="cargo_weight.gif")

```


```{r}
library(ggmap)
library(mapproj)


df2 <- aggregate(CARGO.WEIGHT ~ DESTINATION + FLIGH.DIRECTION, df, sum)
df2[df2$FLIGH.DIRECTION == "Incoming","CARGO.WEIGHT"] <- df2[df2$FLIGH.DIRECTION == "Incoming","CARGO.WEIGHT"] *-1
df2 <- aggregate(CARGO.WEIGHT ~ DESTINATION, df2, sum)
df2[df2$CARGO.WEIGHT == 0, "CARGO.WEIGHT"] <- NA

df2 <- merge(df2, locationCityCoordinates)
df2$normCARGO.WEIGHT <- (df2$CARGO.WEIGHT-min(df2$CARGO.WEIGHT, na.rm = TRUE))/(max(df2$CARGO.WEIGHT, na.rm = TRUE)-min(df2$CARGO.WEIGHT, na.rm = TRUE))

map <- get_map(location = 'Serbia', zoom = 4, maptype = "terrain")

gg <- ggmap(map)
gg <- gg + geom_point(data = df2, 
                 aes(x = lonCi, y = latCi, size = abs(CARGO.WEIGHT)^2, color = CARGO.WEIGHT), alpha = 0.9) 
gg <- gg + theme_bw() + scale_colour_gradient(low = "blue", high = "red")
gg <- gg + labs(x=NULL, y=NULL)
gg <- gg + theme(panel.grid=element_blank(),
                 legend.position="none", panel.border=element_blank(),
                 axis.ticks=element_blank(),
                 axis.text=element_blank())
print(gg)
```


```{r}
library(ggmap)
library(mapproj)


df2 <- aggregate(NBR.OF.PASSENGERS ~ DESTINATION + FLIGH.DIRECTION, df, sum)
df2[df2$FLIGH.DIRECTION == "Incoming","NBR.OF.PASSENGERS"] <- df2[df2$FLIGH.DIRECTION == "Incoming","NBR.OF.PASSENGERS"] *-1
df2 <- aggregate(NBR.OF.PASSENGERS ~ DESTINATION, df2, sum)
df2[df2$NBR.OF.PASSENGERS == 0, "NBR.OF.PASSENGERS"] <- NA

df2 <- merge(df2, locationCityCoordinates)
df2$normNBR.OF.PASSENGERS <- (df2$NBR.OF.PASSENGERS-min(df2$NBR.OF.PASSENGERS, na.rm = TRUE))/(max(df2$NBR.OF.PASSENGERS, na.rm = TRUE)-min(df2$NBR.OF.PASSENGERS, na.rm = TRUE))

map <- get_map(location = 'Serbia', zoom = 4, maptype = "roadmap")

gg <- ggmap(map)
gg <- gg + geom_point(data = df2, 
                 aes(x = lonCi, y = latCi, size = abs(NBR.OF.PASSENGERS), color = NBR.OF.PASSENGERS^3), alpha = 0.8) 
gg <- gg + theme_bw() + scale_colour_gradient(low = "blue", high = "red")
gg <- gg + labs(x=NULL, y=NULL)
gg <- gg + theme(panel.grid=element_blank(),
                 legend.position="none", panel.border=element_blank(),
                 axis.ticks=element_blank(),
                 axis.text=element_blank())
print(gg)
```


```{r}
#devtools::install_github("ropensci/plotly")
library(plotly)

df2$hover <- with(df2, paste("Destination: ", DESTINATION))
df2$absNBR.OF.PASSENGERS <- abs(df2$NBR.OF.PASSENGERS) / 5000

# marker styling
m <- list(
  colorbar = list(title = "Number of passengers"),
  size = ~absNBR.OF.PASSENGERS, opacity = 0.8, symbol = 'sphere'
)

# geo styling
g <- list(
  scope = 'europe',
  projection = list(type = 'albers europe'),
  showland = TRUE,
  landcolor = toRGB("gray65"),
  subunitcolor = toRGB("gray85"),
  countrycolor = toRGB("gray85"),
  countrywidth = 0.5,
  subunitwidth = 0.5
)

jet <- c("#00007F", "blue", "#007FFF", "cyan", "#7FFF7F", "yellow", "#FF7F00", "red", "#7F0000")

plot_ly(df2, lat = ~latCi, lon = ~lonCi, text = ~hover, color = ~NBR.OF.PASSENGERS,
        type = 'scattergeo', locationmode = 'Europe', mode = 'markers', 
        colors = jet,
        marker = m) %>%
  layout(title = 'Where passengers flow from BUD airport', geo = ~g)
```


http://stackoverflow.com/questions/37329433/how-to-build-simple-google-chart-in-shiny

https://trinkerrstuff.wordpress.com/2013/05/11/animations-understood-5/


